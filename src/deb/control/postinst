#!/bin/bash
set -e

# Create user and group for the service
if ! getent group alpidi-printer-agent >/dev/null; then
    addgroup --system alpidi-printer-agent
fi

if ! getent passwd alpidi-printer-agent >/dev/null; then
    adduser --system --ingroup alpidi-printer-agent \
            --home /var/lib/alpidi-printer-agent \
            --no-create-home \
            --gecos "Alpidi Printer Agent" \
            --shell /bin/false \
            alpidi-printer-agent
fi

# Create directories
mkdir -p /var/log/alpidi-printer-agent
mkdir -p /var/lib/alpidi-printer-agent
mkdir -p /etc/alpidi-printer-agent

# Set permissions
chown alpidi-printer-agent:alpidi-printer-agent /var/log/alpidi-printer-agent
chown alpidi-printer-agent:alpidi-printer-agent /var/lib/alpidi-printer-agent
chown alpidi-printer-agent:alpidi-printer-agent /etc/alpidi-printer-agent

# Reload systemd and enable service
if [ -d /run/systemd/system ]; then
    systemctl daemon-reload
    systemctl enable alpidi-printer-agent.service
    
    # Start service if not upgrading
    if [ "$1" = "configure" ] && [ -z "$2" ]; then
        systemctl start alpidi-printer-agent.service
    fi
fi

# Update desktop database
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database -q /usr/share/applications
fi

echo "Alpidi Printer Agent has been installed successfully!"
echo "Service is available at: http://localhost:9000"
echo ""
echo "To start the service manually:"
echo "  sudo systemctl start alpidi-printer-agent"
echo ""
echo "To check service status:"
echo "  sudo systemctl status alpidi-printer-agent"
echo ""
echo "To view logs:"
echo "  sudo journalctl -u alpidi-printer-agent -f"

#DEBHELPER#

exit 0